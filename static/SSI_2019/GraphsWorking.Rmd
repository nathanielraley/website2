---
title: "Intro to Causal Inference"
subtitle: "ðŸ”¥ Day 1 ðŸ”¥"
author: "Nathaniel Woodward ðŸ˜„"
institute: "University of Texas at Austin"
date: "Updated: `r Sys.Date()`"
output:
  xaringan::moon_reader:
    cib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
class: center, middle

![](./images/ut.jpg)

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```

???

Notes to self?

---
class: center, middle

# Try a GIF

![](./images/controlling.gif)

---

# Types of Junctions

```{R echo=F, fig.width=12, fig.height=3.5}
library(dplyr)
library(ggplot2)
library(ggdag)
library(dagitty)
library(gridExtra)

tidy_ggdag <- dagify(y~z,z~x,
             exposure = "x",
             outcome = "y") %>% tidy_dagitty(layout="linear")
p1<-ggdag(tidy_ggdag) +
  theme_dag_blank()+ggtitle("Chain")

dag1<-confounder_triangle()
p2<-ggdag(dag1)+theme_dag_blank()+ggtitle("Fork/Confounder")

dag1<-collider_triangle()
p3<-ggdag(dag1)+theme_dag_blank()+ggtitle("Collider")

grid.arrange(p1,p2,p3,nrow=1)
```



---

# Confounding


- A *back-door path* is any path from X to Y that starts with an arrow *into* X

--

- These are paths that allow for spurious correlations between X and Y!

--

- To *deconfound* X and Y, we must block every backdoor path 

--

<br>

$$P(Y|do(X))=\sum_ZP(Y|X,Z=z)P(Z=z)$$


---

# Confounding

```{R echo=F, fig.width=6, fig.height=4}
library(dplyr)
library(ggplot2)
library(ggdag)
library(dagitty)

dag1<-confounder_triangle(x="Coffee",y="Lung Cancer",z="Smoking")
ggdag(dag1,use_labels = "label",node_size = 15)
```

---

# M-bias

```{R echo=F, fig.width=6, fig.height=4}
m_bias(x = "Education", y = "Diabetes", a = "Income during Childhood", 
       b = "Genetic Risk \nfor Diabetes", m = "Mother's Diabetes") %>% 
  ggdag(use_labels = "label")+theme_dag_blank()
```


---

# M-bias 2

```{R echo=F, fig.width=6, fig.height=4}
m_bias(x = "Smoking", y = "Lung Disease", a = "Attitude towards Norms", 
       b = "Safety/Health Measures", m = "Seatbelt Usage") %>% 
  ggdag(use_labels = "label")+theme_dag_blank()
```


---

#Game 1

```{R echo=F, fig.width=6, fig.height=3}

coords <- tibble::tribble(
  ~name,            ~x,  ~y,
  "Y",    2,   1,
  "A",    1,   1,
  "X",    0,   1,
  "B",    1,   0,
)

tidy_ggdag <- dagify(Y~A,A~X,B~A,
             exposure = "X",
             outcome = "Y",coords = coords) %>% tidy_dagitty()

ggdag_dconnected(tidy_ggdag) +
  theme_dag_blank()
```

--

- In the original, $X=smoking$, $Y=miscarriage$, $A=smoking\text{-}related\ abnormality$ (unobservable), $B=history\ of\ miscarriages$

--

- Don't control for B! (Some of the effect of X on Y happens through B)


---

#Game 2

```{R echo=F, fig.width=6, fig.height=4}

#tree, circle, graphopt, star, grid, linear, mds, lgl,

coords <- tibble::tribble(
  ~name,            ~y,  ~x,
  "X",          0,   0,
  "E",          0,   1,
  "Y",          0,   2,
  "A",     1,   0,
  "B",          1,   1,
  "C",        1,   2,
  "D",        .5,   1
)


tidy_ggdag <- dagify(Y~E,X~A,B~D+A,E~D+X,C~B,
             exposure = "X",
             outcome = "Y",coords=coords) %>% tidy_dagitty(layout="mds")

ggdag_dconnected(tidy_ggdag,edge_type="link") +
  theme_dag_blank()
```


- In the original, $X=currently\ smoking$, $Y=miscarriage$, $A=smoked\ during\ first\ pregnancy$
$B\ and\ E =smoking\text{-}related\ abnormalities$ (unobservable), $C=prior \ miscarriage$

--

- Don't controll for Prior Miscarriages (unless you also control for Prior Smoking)

---

#Game 3

```{R echo=F, fig.width=6, fig.height=4}

tidy_ggdag <- dagify(Y~X+B,X~B,A~B+X,
             exposure = "X",
             outcome = "Y") %>% tidy_dagitty(layout="mds")

ggdag_dconnected(tidy_ggdag,edge_type="link") +
  theme_dag_blank()
```

---

# Low birth-weight paradox

```{R echo=F, fig.width=6, fig.height=4}

coords <- tibble::tribble(
  ~name,            ~x,  ~y,
  "X",          0,   2,
  "A",          0,   0,
  "B",          0,   1,
  "Y",          1,   1
)


tidy_ggdag <- dagify(Y~X,Y~A,Y~B,B~A,B~X,
             exposure = "X",
             outcome = "Y",coords=coords) %>% tidy_dagitty(layout="mds")

ggdag_dconnected(tidy_ggdag,edge_type="link") +
  theme_dag_blank()
```

---

# Front-door criterion

```{R echo=F, fig.width=6, fig.height=4}

coords <- tibble::tribble( 
  ~name,            ~x,  ~y,
  "X",          0,   0,
  "Y",          2,   0,
  "M",          1,   0,
  "C",          1,   1
)


tidy_ggdag <- dagify(Y~M,Y~C,M~X,X~C,
             exposure = "X",
             outcome = "Y",coords=coords) %>% tidy_dagitty(layout="mds")

ggdag_dconnected(tidy_ggdag,edge_type="link") +
  theme_dag_blank()
```

- Very useful for unobservable confounders C

- This was the first causal effect estimated by means other than control for confounders

1. Estimate effect of X on M by observing $P(M|do(x))=P(M|X)$

1. Estimate effect of M on Y by blocking back-door path (control for X): $P(Y|do(M))=\sum_xP(Y|M,X)$

1. $P(Y|X)=\sum_MP(Y|do(M))P(M|do(X))$

---

# Glynn and Kashin, 2014

```{R echo=F, fig.width=6, fig.height=3.5}

coords <- tibble::tribble( 
  ~name,            ~x,  ~y,
  "X",          0,   0,
  "Y",          2,   0,
  "M",          1,   0,
  "C",          1,   1
)



tidy_ggdag <- dagify(Y~M,Y~C,M~X,X~C,M~C,
             exposure = "X",
             outcome = "Y",coords=coords,labels=c(X="Enrolled",M="Attended",Y="Earnings",C="Motivation")) %>% tidy_dagitty(layout="mds")
ggdag(tidy_ggdag, use_labels = "label") +
  theme_dag_blank()
```


- Data from Department of Labor job-training program from 1987-1989

- RCT (people assigned to program) and observational study (people chose for themselves)

- Back-door adjustment (controlling for known confounders like age, race, site) failed due to unobservable confounder Motivation

- Front-door adjustment matched RCT results almost perfectly


---

# Three rules of do-calculus

1. Observing a variable W that is irrelevant to Y (possibly conditional on other variables Z) does not affect the probability distribution of Y

$$
P(Y|do(X),Z,W)=P(Y|do(X),Z)
$$
(Z must block all paths from W to Y after deleting arrows leading into X)

1. If a set of Z variables blocks all back-door paths from X to Y, then conditional on Z, do(X) is the same as see(X)

$$
P(Y|do(X),Z)=P(Y|X,Z)
$$

1. We can remove $do(X)$ from $P(Y|do(X))$ in any case where there are no causal paths from X to Y

$$
P(Y|do(X))=P(Y)
$$

--

Interestingy, all you need are Rules 1 and 3: if you cannot find a way to estimate $P(Y|do(X))$ from 1 and 3, then a solution does not exist! Thus, no alternative but to conduct an RCT
---

# Do-Calculus at work

$$\begin{aligned}
P(Y|do(X))&=\sum_MP(Y|do(X),M)P(M|do(X))\\
&=\sum_MP(Y|do(X),do(M))P(M|do(X)) \ \ \ \ \ \ \ \ \ \ \ \text{by Rule 2}\\
&=\sum_MP(Y|do(X),do(M))P(M|X) \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \  \text{by Rule 2}\\
&=\sum_MP(Y|do(M))P(M|X) \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \  \ \ \ \ \ \ \ \ \ \text{by Rule 3}\\
&=\sum_{X'}\sum_MP(Y|do(M),X')P(X'|do(M))P(M|X) \\
&=\sum_{X'}\sum_MP(Y|M,X')P(X'|do(M))P(M|X) \  \text{by Rule 2}\\
&=\sum_{X'}\sum_MP(Y|M,X')P(X'))P(M|X) \ \ \ \ \ \ \ \ \ \ \ \ \text{by Rule 3}\\
\end{aligned}$$

---

# Barbara Burks

```{R echo=F, fig.width=6, fig.height=4}

coords <- tibble::tribble(
  ~name,            ~x,  ~y,
  "pIQ",          0,   0,
  "SES",          1,   1,
  "U",            2,   2,
  "cIQ",          2,   0
)


tidy_ggdag <- dagify(cIQ~pIQ+SES+U,pIQ~SES,SES~U+pIQ,
             exposure = "pIQ",
             outcome = "cIQ",coords=coords) %>% tidy_dagitty(layout="mds")

ggdag_dconnected(tidy_ggdag,edge_type="link") +
  theme_dag_blank()
```

- Bias is introduced if we condition on variables that are (a) effects of either pIQ or cIQ, or (b) effects of unmeasured causes of ether pIQ or cIQ (such as U)

- "Logical considerations lead to the conclusion that the techniques of partial and multiple correlation are fraught with dangers that seriously restrict their applicability" - Barbara Burks (1926)


---
## Working Admit Simpsons

```{R}
admit<-as.data.frame(UCBAdmissions)
admit$Admit<-as.numeric(admit$Admit)

admit%>%group_by(Gender,Dept)%>%
  summarize(AdmitRate=Freq[Admit==1]/sum(Freq))%>%ungroup()%>%
  group_by(Dept)%>%summarize(diff=AdmitRate[Gender=='Female']-AdmitRate[Gender=="Male"])%>%summarize(mean(diff))

admit%>%group_by(Gender)%>%
  summarize(AdmitRate=sum(Freq[Admit==1])/sum(Freq))%>%ungroup()%>%
  summarize(diff=AdmitRate[Gender=='Female']-AdmitRate[Gender=="Male"])%>%summarize(mean(diff))


```